!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["mqtt"],b):a.EVT.WS=a.Evrythng.WS=b(a.mqtt)}(this,function(a){"use strict";function b(a){return a+"_"+Math.random().toString(16).substr(2,8)}function c(a){return a.wsClient&&a.wsClient.connected===!0}function d(d){return k[d.apiKey]?k[d.apiKey]:(k[d.apiKey]=new Promise(function(e,f){function g(a){delete k[d.apiKey],d.wsClient||(o.end(),f(a))}function i(){l[d.apiKey]&&Object.keys(l[d.apiKey]).forEach(function(a){o.subscribe(a)}),d.wsClient=o,e(d.wsClient)}if(c(d))e(d.mqttClient);else{var j=m.settings,n={username:"authorization",password:d.apiKey,clientId:b(j.clientIdPrefix),keepalive:j.keepAlive,reconnectPeriod:j.reconnectPeriod},o=a.connect(j.apiUrl,n);o.on("connect",i),o.on("close",g),o.on("error",g),o.on("message",function(a,b){h(d.apiKey,a,b)})}}),k[d.apiKey])}function e(a,b,c){var e=this;return d(this.scope).then(function(d){return new Promise(function(f,g){function h(a){a?(c&&c(a),g(a)):(b&&b(),f())}a=JSON.stringify(e.jsonify(a)),d.publish(e.path,a,h)})}).catch(function(a){return c&&c(a),Promise.reject(a)})}function f(a,b,c){l[a.apiKey]||(l[a.apiKey]={}),l[a.apiKey][b]||(l[a.apiKey][b]=[]),l[a.apiKey][b].push(c)}function g(a,b){delete l[a.apiKey][b]}function h(a,b,c){l[a][b]&&l[a][b].forEach(function(a){a(c)})}var i="2.0.2",j={apiUrl:"wss://ws.evrythng.com:443/mqtt",reconnectPeriod:1e3,keepAlive:50,clientIdPrefix:"evtjs"},k={},l={},m={version:i,settings:j,setup:function(a){if("[object Object]"!==Object.prototype.toString.call(a))throw new TypeError("Setup should be called with an options object.");for(var b in a)if(a.hasOwnProperty(b)){if("keepAliveInterval"===b){console.warn("[EvrythngJS WS] keepAliveInterval option has been deprecated. Use keepAlive instead."),this.settings.keepAlive=a[b];continue}this.settings[b]=a[b]}return this.settings},install:function(a,b){function h(a,b,c){if("[object Function]"!=Object.prototype.toString.call(a))throw new TypeError("Message callback missing.");var e=this;return d(e.scope).then(function(d){return new Promise(function(g,h){function i(i){i?(c&&c(i),h(i)):(f(e.scope,e.path,function(b){var c=b.toString();try{c=e.parse(JSON.parse(c))}catch(a){}a(c)}),b&&b(d),g(d))}d.subscribe(e.path,i)})}).catch(function(a){return c&&c(a),Promise.reject(a)})}function i(a,b){var d=this;return new Promise(function(e,f){function h(c){c?(b&&b(c),f(c)):(g(d.scope,d.path),a&&a(d.scope.wsClient),e(d.scope.wsClient))}if(!c(d.scope)){var i=new Error("WS Client is not connected.");return b&&b(i),f(i)}d.scope.wsClient.unsubscribe(d.path,h)})}function j(a,c,d){var f=this;"undefined"==typeof a&&(a={});var g=this.class===b.class?"create":"update";return new Promise(function(b,h){var i={request:function(a,g){g(),e.call(f,a.data,c,d).then(b,h)}};f[g](a,{interceptors:[i]}).catch(function(a){if(!a.cancelled)throw a})})}a.prototype.subscribe=h,a.prototype.unsubscribe=i,a.prototype.publish=j}};return m.$inject=["resource","entity/action"],m});
//# sourceMappingURL=evrythng-ws.min.js.map