!function(a,b){"use strict";"function"==typeof define&&define.amd?define(["bower-mqttws"],b):a.EVT.WS=a.Evrythng.WS=b(a.Paho)}(this,function(a){"use strict";function b(a){return a+"_"+Math.random().toString(16).substr(2,8)}function c(b){return b.wsClient instanceof a.MQTT.Client&&b.wsClient.isConnected()}function d(d){return l[d.apiKey]?l[d.apiKey]:(l[d.apiKey]=new Promise(function(e,f){function g(a){delete l[d.apiKey],d.wsClient?r||(r=setInterval(function(){try{k.connect(i())}catch(a){}},p.reconnectPeriod)):f(a)}function h(){r&&clearInterval(r),m[d.apiKey]&&Object.keys(m[d.apiKey]).forEach(function(a){m[d.apiKey][a]()}),d.wsClient=k,e(d.wsClient)}function i(){return{userName:"authorization",password:d.apiKey,keepAliveInterval:p.keepAlive,onSuccess:h,onFailure:g}}function j(a){n[d.apiKey][a.destinationName](a)}var k,p=o.settings,q=p.apiUrl,r=null,s=b(p.clientIdPrefix);c(d)?e(d.wsClient):(k=new a.MQTT.Client(q,s),k.connect(i()),k.onConnectionLost=g,k.onMessageArrived=j)}),l[d.apiKey])}function e(b,c,e){var f=this;return d(this.scope).then(function(d){return new Promise(function(e){b=JSON.stringify(f.jsonify(b)),b=new a.MQTT.Message(b),b.destinationName=f.path,d.onMessageDelivered=function(){c&&c(),e()},d.send(b)})},function(a){return e&&e(a),Promise.reject(a)})}function f(a,b,c){m[a.apiKey]||(m[a.apiKey]={}),m[a.apiKey][b]||(m[a.apiKey][b]=c)}function g(a,b){m[a.apiKey]&&delete m[a.apiKey][b]}function h(a,b,c){n[a.apiKey]||(n[a.apiKey]={}),n[a.apiKey][b]||(n[a.apiKey][b]=c)}function i(a,b){n[a.apiKey]&&delete n[a.apiKey][b]}var j="1.0.3",k={apiUrl:"wss://ws.evrythng.com:443/mqtt",reconnectPeriod:1e3,keepAlive:50,clientIdPrefix:"evtjs"},l={},m={},n={},o={version:j,settings:k,setup:function(a){if("[object Object]"!==Object.prototype.toString.call(a))throw new TypeError("Setup should be called with an options object.");for(var b in a)if(a.hasOwnProperty(b)){if("keepAliveInterval"===b){console.warn("[EvrythngJS WS] keepAliveInterval option has been deprecated. Use keepAlive instead."),this.settings.keepAlive=a[b];continue}this.settings[b]=a[b]}return this.settings},install:function(a,b){function j(a,b,c){if("[object Function]"!=Object.prototype.toString.call(a))throw new TypeError("Message callback missing.");var e=this;return d(e.scope).then(function(d){return new Promise(function(g,i){d.subscribe(e.path,{onSuccess:function(){f(e.scope,e.path,j.bind(e,a)),h(e.scope,e.path,function(b){var c=b.payloadString;try{c=e.parse(JSON.parse(c))}catch(d){}a(c)}),b&&b(d),g(d)},onFailure:function(a){c&&c(a),i(a)}})})},function(a){return c&&c(a),Promise.reject(a)})}function k(a,b){var d=this;return new Promise(function(e,f){if(c(d.scope))d.scope.wsClient.unsubscribe(d.path,{onSuccess:function(){g(d.scope,d.path),i(d.scope,d.path),a&&a(),e(d.scope.wsClient)},onFailure:function(a){console.error("Unable to unsubscribe to "+d.path),b&&b(a),f(a)}});else{var h=new Error("MQTT Client is not connected.");b&&b(h),f("WS Client is not connected.")}})}function m(a,c,d){var f=this;"undefined"==typeof a&&(a={});var g=this["class"]===b["class"]?"create":"update";return new Promise(function(b,h){var i={request:function(a,g){g(),e.call(f,a.data,c,d).then(b,h)}};f[g](a,{interceptors:[i]})["catch"](function(a){if(!a.cancelled)throw a})})}l={},a.prototype.subscribe=j,a.prototype.unsubscribe=k,a.prototype.publish=m}};return o.$inject=["resource","entity/action"],o});
//# sourceMappingURL=evrythng-ws.min.js.map